<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocab Spell Master Pro</title>
    <!-- External Library Whitelist -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load the external data file from the same directory -->
    <script src="vocabData.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Lexend:wght@400;900&display=swap');

        :root {
            --primary: #6366f1;
            --bg: #eef2ff;
        }

        body {
            font-family: 'Lexend', sans-serif;
            background-color: var(--bg);
            touch-action: manipulation;
            overflow-x: hidden;
        }

        .funny-font { font-family: 'Fredoka One', cursive; }

        /* Neo-brutalist Design System */
        .neo-shadow {
            box-shadow: 10px 10px 0px 0px rgba(0,0,0,1);
        }

        .neo-shadow-sm {
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
        }

        .neo-button:active {
            box-shadow: 0px 0px 0px 0px rgba(0,0,0,1);
            transform: translate(4px, 4px);
        }

        .key-button:active {
            box-shadow: 0px 0px 0px 0px rgba(0,0,0,1);
            transform: translate(2px, 2px);
        }

        /* Word Box Styling */
        .word-box {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            border-radius: 8px;
            border: 2px solid black;
            background: white;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        .word-box.filled {
            background: #4ade80;
            color: white;
            border-style: solid;
            transform: translateY(-2px);
            box-shadow: 0px 4px 0px 0px rgba(0,0,0,1);
        }

        .word-box.symbol {
            border: none;
            background: transparent;
        }

        /* Layout Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .shake { animation: shake 0.2s ease-in-out 0s 2; }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <!-- Header Navigation -->
    <div class="w-full max-w-2xl flex justify-between items-center mb-6 mt-2">
        <div class="bg-white border-4 border-black px-4 py-2 rounded-2xl neo-shadow-sm">
            <select id="levelSelect" class="bg-transparent font-black text-lg outline-none cursor-pointer uppercase">
                <!-- Populated via JS -->
            </select>
        </div>
        <div class="bg-white border-4 border-black px-6 py-2 rounded-2xl neo-shadow-sm flex items-center gap-3">
            <span class="text-2xl">‚≠ê</span>
            <span id="scoreDisplay" class="text-2xl font-black">0</span>
        </div>
    </div>

    <!-- Main Game Canvas -->
    <div id="gameBoard" class="w-full max-w-2xl bg-white rounded-[3rem] border-4 border-black neo-shadow p-8 mb-8 relative transition-all">
        <div class="text-center">
            <div id="posTag" class="inline-block bg-yellow-300 px-4 py-1 rounded-full text-xs font-black border-2 border-black mb-6 uppercase tracking-widest">
                PART OF SPEECH
            </div>
            
            <h2 id="chineseMeaning" class="text-4xl md:text-5xl font-black mb-10 text-indigo-900 funny-font tracking-tight">
                Loading...
            </h2>
            

            <!-- Dynamic Word Container -->
            <div id="wordContainer" class="flex items-center justify-center gap-1.5 mb-12 overflow-x-auto no-scrollbar whitespace-nowrap px-2 py-4">
                <!-- Boxes dynamically sized and generated by JS -->
            </div>

            <!-- Action Bar -->
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button onclick="game.useHint()" class="flex-1 bg-orange-400 text-white py-4 rounded-2xl border-4 border-black neo-shadow-sm neo-button font-black text-xl flex items-center justify-center gap-2">
                    üí° GET HINT
                </button>
                <button onclick="game.skipWord()" class="flex-1 bg-blue-400 text-white py-4 rounded-2xl border-4 border-black neo-shadow-sm neo-button font-black text-xl flex items-center justify-center gap-2">
                    ‚è≠Ô∏è SKIP WORD
                </button>
                <button onclick="game.speakWord()"class="flex-1 bg-blue-400 text-white py-4 rounded-2xl border-4 border-black neo-shadow-sm neo-button font-black text-xl flex items-center justify-center gap-2">
                    üîäPLAY</button>
            </div>
        </div>
    </div>

    <!-- Professional Virtual Keyboard -->
    <div id="keyboard" class="w-full max-w-xl flex flex-col gap-2 px-2 mb-10">
        <!-- Rows generated by JS -->
    </div>

    <!-- Success Overlay -->
    <div id="winModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-indigo-950/90 backdrop-blur-sm p-6">
        <div class="bg-white p-10 rounded-[3.5rem] border-8 border-black shadow-2xl text-center max-w-md w-full transform rotate-1">
            <div class="text-6xl mb-4">üéâ</div>
            <h3 class="text-5xl font-black mb-6 funny-font italic text-green-500">EXCELLENT!</h3>
            <div class="bg-indigo-50 p-6 rounded-3xl border-4 border-black mb-8">
                <p id="correctWordDisplay" class="text-4xl font-black text-indigo-600 mb-2 uppercase tracking-tighter"></p>
                <p id="correctZhDisplay" class="text-xl text-gray-600 font-bold"></p>
            </div>
            <button onclick="game.speakWord()"class="flex-1 bg-blue-400 text-white py-4 rounded-2xl border-4 border-black neo-shadow-sm neo-button font-black text-xl flex items-center justify-center gap-2">
                    üîäPLAY</button>
            <button onclick="game.nextWord()" class="w-full bg-green-400 text-black py-5 rounded-3xl border-4 border-black neo-shadow-sm neo-button font-black text-2xl hover:bg-green-300 transition-colors">
                CONTINUE
            </button>
        </div>
    </div>

    <script>
        class VocabGame {
            constructor() {
                // Check for external data source
                this.db = typeof OXFORD_VOCAB_DB !== 'undefined' ? OXFORD_VOCAB_DB : null;
                this.currentLevel = 'A1';
                this.currentWord = null;
                this.userInput = "";
                this.hintsUsed = 0;
                this.score = 0;
                this.gameState = 'playing';

                if (!this.db) {
                    this.handleMissingData();
                    return;
                }

                this.init();
            }

            handleMissingData() {
                document.getElementById('chineseMeaning').innerHTML = 
                    `<span class="text-red-500 text-xl">Error: 'vocabData.js' not found in directory.</span>`;
                console.error("Data file missing.");
            }

            init() {
                const levelSelect = document.getElementById('levelSelect');
                Object.keys(this.db).forEach(lvl => {
                    const opt = document.createElement('option');
                    opt.value = lvl;
                    opt.textContent = `${lvl} LEVEL`;
                    levelSelect.appendChild(opt);
                });

                levelSelect.addEventListener('change', (e) => {
                    this.currentLevel = e.target.value;
                    this.nextWord();
                });

                this.renderKeyboard();
                this.nextWord();
            }

            renderKeyboard() {
                const layout = [
                    ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
                    ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'],
                    ['Z', 'X', 'C', 'V', 'B', 'N', 'M', '‚å´']
                ];
                const kb = document.getElementById('keyboard');
                layout.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = "flex justify-center gap-1.5";
                    row.forEach(key => {
                        const btn = document.createElement('button');
                        btn.className = `key-button h-14 rounded-xl border-2 border-black neo-shadow-sm font-black text-lg flex items-center justify-center transition-all ${key === '‚å´' ? 'w-16 bg-red-400 text-white' : 'w-11 bg-white'}`;
                        btn.textContent = key;
                        btn.onclick = () => this.handleInput(key);
                        rowDiv.appendChild(btn);
                    });
                    kb.appendChild(rowDiv);
                });
            }

            nextWord() {
                const words = this.db[this.currentLevel];
                this.currentWord = words[Math.floor(Math.random() * words.length)];
                this.userInput = "";
                this.hintsUsed = 0;
                this.gameState = 'playing';
                
                document.getElementById('winModal').classList.add('hidden');
                document.getElementById('posTag').textContent = this.currentWord.pos;
                document.getElementById('chineseMeaning').textContent = this.currentWord.zh;
                this.renderWordBoxes();
            }
             speakWord() {
                // 1. Check if we have a current word
                if (!this.currentWord || !this.currentWord.en) return;

                // 2. Cancel any currently playing speech (prevents overlapping audio)
                window.speechSynthesis.cancel();

                // 3. Create the utterance using the SPECIFIC English word (this.currentWord.en)
                const utterance = new SpeechSynthesisUtterance(this.currentWord.en);
                
                // 4. Settings
                utterance.lang = 'en-GB'; // Use 'en-GB' for British accent
                utterance.rate = 0.8;     // Slightly slower is better for learning
                
                // 5. Speak
                window.speechSynthesis.speak(utterance);
            }
            renderWordBoxes() {
                const container = document.getElementById('wordContainer');
                container.innerHTML = '';
                
                const wordLength = this.currentWord.en.length;
                
                // Dynamic Scaling Logic: Adjust box size based on word length
                // Base size is 3.5rem, shrinks as word gets longer
                let boxSize = "3.5rem";
                let fontSize = "1.5rem";

                if (wordLength > 8) {
                    boxSize = "2.8rem";
                    fontSize = "1.2rem";
                }
                if (wordLength > 12) {
                    boxSize = "2.2rem";
                    fontSize = "1rem";
                }
                if (wordLength > 16) {
                    boxSize = "1.8rem";
                    fontSize = "0.8rem";
                }

                let letterCounter = 0;
                this.currentWord.en.split('').forEach((char) => {
                    const box = document.createElement('div');
                    const isLetter = /[a-zA-Z]/.test(char);
                    
                    box.style.width = boxSize;
                    box.style.height = `calc(${boxSize} * 1.3)`;
                    box.style.fontSize = fontSize;

                    if (isLetter) {
                        box.className = 'word-box';
                        if (this.userInput.length > letterCounter) {
                            box.textContent = char.toUpperCase();
                            box.classList.add('filled');
                        }
                        letterCounter++;
                    } else {
                        box.className = 'word-box symbol';
                        box.textContent = char;
                        box.style.width = 'auto';
                        box.style.padding = '0 4px';
                    }
                    container.appendChild(box);
                });

                // Ensure the active typing area is visible
                container.scrollLeft = container.scrollWidth;
            }

            handleInput(key) {
                if (this.gameState !== 'playing') return;

                if (key === '‚å´') {
                    this.userInput = this.userInput.slice(0, -1);
                    this.renderWordBoxes();
                    return;
                }

                const cleanTarget = this.currentWord.en.toLowerCase().replace(/[^a-z]/g, '');
                const targetChar = cleanTarget[this.userInput.length];

                if (key.toLowerCase() === targetChar) {
                    this.userInput += key.toLowerCase();
                    this.renderWordBoxes();
                    
                    if (this.userInput === cleanTarget) {
                        this.win();
                    }
                } else {
                    const board = document.getElementById('gameBoard');
                    board.classList.add('shake');
                    setTimeout(() => board.classList.remove('shake'), 250);
                }
            }

            useHint() {
                const cleanTarget = this.currentWord.en.toLowerCase().replace(/[^a-z]/g, '');
                if (this.userInput.length < cleanTarget.length) {
                    this.userInput += cleanTarget[this.userInput.length];
                    this.hintsUsed++;
                    this.renderWordBoxes();
                    if (this.userInput === cleanTarget) this.win();
                }
            }

            skipWord() {
                this.nextWord();
            }

            win() {
                this.gameState = 'won';
                const points = Math.max(10 - this.hintsUsed, 1);
                this.score += points;
                document.getElementById('scoreDisplay').textContent = this.score;
                document.getElementById('correctWordDisplay').textContent = this.currentWord.en;
                document.getElementById('correctZhDisplay').textContent = this.currentWord.zh;
                
                setTimeout(() => {
                    document.getElementById('winModal').classList.remove('hidden');
                }, 400);
            }
        }

        // Instantiate the game controller
        const game = new VocabGame();
    </script>
</body>
</html>