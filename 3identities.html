<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>恆等式大師</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Active Input Highlight */
        .input-active {
            border-color: #3b82f6 !important; /* Blue-500 */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            background-color: #eff6ff;
        }

        /* Keyboard Slide Animation */
        #virtual-keyboard {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .keyboard-hidden { transform: translateY(100%); }
        .keyboard-visible { transform: translateY(0); }

        /* Superscript styling */
        sup {
            font-size: 0.6em;
            vertical-align: super;
            margin-left: 2px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 flex flex-col items-center pb-80"> 

    <!-- Header & Score -->
    <div class="w-full max-w-2xl flex justify-between items-center mt-6 mb-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200 mx-4">
        <div class="flex items-center gap-2 text-lg font-bold text-slate-700">
            <div class="bg-blue-100 p-2 rounded-lg">
                <i data-lucide="sigma" class="w-5 h-5 text-blue-600"></i>
            </div>
            <span>恆等式大師</span>
        </div>
        <div class="bg-blue-50 text-blue-800 px-4 py-1 rounded-full font-bold shadow-inner border border-blue-100">
            Score: <span id="score-display">0</span>
        </div>
    </div>

    <!-- Game Container -->
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 mx-4 relative">
        
        <!-- Formula Hint Panel (Initially Hidden) -->
        <div id="hint-panel" class="hidden bg-amber-50 border-b border-amber-100 p-3 text-center text-amber-800 text-sm font-medium flex justify-center items-center gap-2 transition-all">
            <i data-lucide="lightbulb" class="w-4 h-4"></i>
            <span id="formula-text">Formula Hint Loading...</span>
        </div>

        <!-- Problem Display -->
        <div class="bg-slate-900 text-white p-8 text-center relative overflow-hidden">
            <!-- Background decoration -->
            <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                <div class="absolute top-[-50%] left-[-10%] w-[500px] h-[500px] rounded-full bg-blue-500 blur-3xl"></div>
            </div>

            <!-- Hint Toggle Button (Top Right) -->
            <div class="absolute top-4 right-4 z-20">
                <button id="hint-btn" onclick="showHint()" class="bg-white/10 hover:bg-white/20 text-blue-200 hover:text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-1.5 transition-colors backdrop-blur-sm border border-white/10">
                    <i data-lucide="lightbulb" class="w-3 h-3"></i> 顯示提示
                </button>
            </div>

            <div class="relative z-10 mt-2">
                <div class="text-sm text-slate-400 mb-2 font-bold tracking-wide">使用恆等式展開以下多項式</div>
                <!-- Problem Text -->
                <div id="problem-text" class="text-3xl md:text-5xl font-mono font-bold tracking-wide py-4">
                    <!-- Problem goes here -->
                </div>
            </div>
        </div>

        <div class="p-6 md:p-8 space-y-8">
            
            <!-- Input Area -->
            <div id="game-area">
                <div class="text-center mb-6 text-slate-600 font-medium">
                    填入展開後的係數 (Coefficients)
                </div>
                
                <!-- The Polynomial Template: Ax^2 + Bx + C -->
                <div class="flex flex-wrap items-center justify-center gap-2 md:gap-3 bg-slate-50 p-4 md:p-6 rounded-2xl border border-slate-200 shadow-inner">
                    
                    <!-- Term 1: x^2 -->
                    <div class="flex flex-col items-center gap-1">
                        <input id="ans-a" type="text" readonly onclick="activateInput('ans-a')" placeholder="?" class="cursor-pointer w-16 h-14 text-center border-2 border-slate-300 rounded-xl text-2xl font-mono bg-white text-slate-700 focus:outline-none transition-all shadow-sm">
                        <span class="font-serif text-lg text-slate-400 italic">x<sup>2</sup></span>
                    </div>

                    <!-- Sign 1 (Blue Default) -->
                    <button id="sign-1" onclick="toggleSign('sign-1')" class="sign-btn w-10 h-10 rounded-full font-bold text-xl flex items-center justify-center transition-all bg-blue-100 text-blue-600 border-2 border-blue-200 hover:bg-blue-200 mb-6" data-sign="+">+</button>

                    <!-- Term 2: x -->
                    <div class="flex flex-col items-center gap-1">
                        <input id="ans-b" type="text" readonly onclick="activateInput('ans-b')" placeholder="?" class="cursor-pointer w-16 h-14 text-center border-2 border-slate-300 rounded-xl text-2xl font-mono bg-white text-slate-700 focus:outline-none transition-all shadow-sm">
                        <span class="font-serif text-lg text-slate-400 italic">x</span>
                    </div>

                    <!-- Sign 2 (Blue Default) -->
                    <button id="sign-2" onclick="toggleSign('sign-2')" class="sign-btn w-10 h-10 rounded-full font-bold text-xl flex items-center justify-center transition-all bg-blue-100 text-blue-600 border-2 border-blue-200 hover:bg-blue-200 mb-6" data-sign="+">+</button>

                    <!-- Term 3: Constant -->
                    <div class="flex flex-col items-center gap-1">
                        <input id="ans-c" type="text" readonly onclick="activateInput('ans-c')" placeholder="?" class="cursor-pointer w-16 h-14 text-center border-2 border-slate-300 rounded-xl text-2xl font-mono bg-white text-slate-700 focus:outline-none transition-all shadow-sm">
                        <span class="font-serif text-lg text-slate-400 italic">1</span>
                    </div>
                </div>

                <div class="mt-2 text-center text-xs text-slate-400">
                    *如果某項不存在 (例如 0x)，請填 0
                </div>

                <!-- Submit Button -->
                <div class="mt-8 text-center">
                    <button id="check-btn" onclick="checkAnswer()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-xl font-bold text-lg transition-all active:scale-95 shadow-lg shadow-blue-200 flex items-center justify-center gap-2 mx-auto">
                        <span>提交答案</span>
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Feedback / Result Area -->
            <div id="feedback-area" class="hidden rounded-xl p-5 border-l-4 flex flex-col md:flex-row items-start md:items-center gap-4 fade-in">
                <div id="feedback-icon" class="p-2 rounded-full shrink-0"></div>
                <div class="flex-1">
                    <h4 id="feedback-title" class="font-bold text-lg"></h4>
                    <p id="feedback-detail" class="text-sm opacity-90 mt-1"></p>
                </div>
                <button id="next-btn" onclick="initGame()" class="hidden shrink-0 bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-700 flex items-center gap-2 transition-colors">
                    下一題 <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>

        </div>
    </div>
    
    <!-- VIRTUAL KEYBOARD -->
    <div id="virtual-keyboard" class="fixed bottom-0 left-0 w-full bg-slate-100 border-t border-slate-300 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-50 keyboard-hidden pb-6">
        <!-- Keyboard Header -->
        <div class="flex justify-between items-center px-4 py-2 bg-slate-200 border-b border-slate-300">
            <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Numeric Keypad</span>
            <button onclick="hideKeyboard()" class="text-slate-600 hover:text-slate-900 p-2 bg-slate-300 rounded-md">
                <i data-lucide="chevron-down" class="w-5 h-5"></i>
            </button>
        </div>
        
        <!-- Keys Grid -->
        <div class="grid grid-cols-3 gap-2 p-3 max-w-md mx-auto">
            <button onclick="kpPress(1)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">1</button>
            <button onclick="kpPress(2)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">2</button>
            <button onclick="kpPress(3)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">3</button>
            
            <button onclick="kpPress(4)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">4</button>
            <button onclick="kpPress(5)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">5</button>
            <button onclick="kpPress(6)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">6</button>
            
            <button onclick="kpPress(7)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">7</button>
            <button onclick="kpPress(8)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">8</button>
            <button onclick="kpPress(9)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">9</button>
            
            <button onclick="kpBackspace()" class="h-14 bg-rose-50 rounded-lg shadow-sm text-xl font-bold text-rose-600 active:bg-rose-100 border-b-2 border-rose-200 active:border-b-0 active:translate-y-[2px] flex items-center justify-center">
                <i data-lucide="delete" class="w-6 h-6"></i>
            </button>
            <button onclick="kpPress(0)" class="h-14 bg-white rounded-lg shadow-sm text-2xl font-bold text-slate-700 active:bg-slate-200 border-b-2 border-slate-200 active:border-b-0 active:translate-y-[2px]">0</button>
            <button onclick="hideKeyboard()" class="h-14 bg-blue-600 rounded-lg shadow-sm text-xl font-bold text-white active:bg-blue-700 border-b-2 border-blue-800 active:border-b-0 active:translate-y-[2px] flex items-center justify-center">
                OK
            </button>
        </div>
    </div>

    <!-- Game Logic -->
    <script>
        let score = 0;
        let currentProblem = {};
        let activeInputId = null;

        // Constants
        const TYPE_SQUARE_SUM = 0; // (a+b)^2
        const TYPE_SQUARE_DIFF = 1; // (a-b)^2
        const TYPE_DIFF_SQUARES = 2; // (a+b)(a-b)

        // CSS Classes for the buttons
        const BTN_PLUS_CLASSES = ['bg-blue-100', 'text-blue-600', 'border-blue-200', 'hover:bg-blue-200'];
        const BTN_MINUS_CLASSES = ['bg-orange-100', 'text-orange-600', 'border-orange-200', 'hover:bg-orange-200'];
        const BTN_BASE_CLASSES = ['sign-btn', 'w-10', 'h-10', 'rounded-full', 'font-bold', 'text-xl', 'flex', 'items-center', 'justify-center', 'transition-all', 'mb-6', 'border-2'];

        window.onload = function() {
            lucide.createIcons();
            initGame();
        };

        // --- KEYBOARD LOGIC ---
        function activateInput(id) {
            const inputEl = document.getElementById(id);
            if (inputEl.disabled) return;

            activeInputId = id;
            
            // UI Highlights
            document.querySelectorAll('input').forEach(el => el.classList.remove('input-active'));
            inputEl.classList.add('input-active');
            
            // Show Keyboard
            const kb = document.getElementById('virtual-keyboard');
            kb.classList.remove('keyboard-hidden');
            kb.classList.add('keyboard-visible');
        }

        function hideKeyboard() {
            const kb = document.getElementById('virtual-keyboard');
            kb.classList.remove('keyboard-visible');
            kb.classList.add('keyboard-hidden');
            
            document.querySelectorAll('input').forEach(el => el.classList.remove('input-active'));
            activeInputId = null;
        }

        function kpPress(num) {
            if (!activeInputId) return;
            const input = document.getElementById(activeInputId);
            // Limit to 4 digits to prevent layout breaking
            if (input.value.length < 4) { 
                input.value += num;
            }
        }

        function kpBackspace() {
            if (!activeInputId) return;
            const input = document.getElementById(activeInputId);
            input.value = input.value.slice(0, -1);
        }
        // -----------------------

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function initGame() {
            hideKeyboard();
            
            // Reset UI
            document.getElementById('feedback-area').classList.add('hidden');
            document.getElementById('check-btn').classList.remove('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            
            // Reset Hint
            document.getElementById('hint-panel').classList.add('hidden');
            document.getElementById('hint-btn').classList.remove('hidden');

            // Reset Inputs
            ['ans-a', 'ans-b', 'ans-c'].forEach(id => {
                const el = document.getElementById(id);
                el.value = '';
                el.disabled = false;
                el.classList.remove('bg-gray-100', 'text-gray-400');
            });

            // Reset Signs to Plus (Blue)
            ['sign-1', 'sign-2'].forEach(id => {
                const btn = document.getElementById(id);
                btn.dataset.sign = '+';
                btn.textContent = '+';
                btn.className = ''; // Clear all
                btn.classList.add(...BTN_BASE_CLASSES, ...BTN_PLUS_CLASSES);
                btn.disabled = false;
            });

            generateProblem();
        }

        function generateProblem() {
            // Randomly choose problem type
            const type = getRandomInt(0, 2);
            
            // Generate coefficients
            // A*x +/- B
            let A = getRandomInt(1, 5);
            let B = getRandomInt(1, 9);
            
            // Make simple cases (A=1) more common for beginners
            if (Math.random() > 0.7) A = 1;

            currentProblem = { type, A, B };
            renderProblem();
        }

        function renderProblem() {
            const { type, A, B } = currentProblem;
            const aTerm = A === 1 ? 'x' : `${A}x`;
            let html = '';
            let formula = '';

            // Using <sup>2</sup> for real squares
            if (type === TYPE_SQUARE_SUM) {
                html = `(${aTerm} + ${B})<sup>2</sup>`;
                formula = "提示: (a + b)² = a² + 2ab + b²";
            } else if (type === TYPE_SQUARE_DIFF) {
                html = `(${aTerm} - ${B})<sup>2</sup>`;
                formula = "提示: (a - b)² = a² - 2ab + b²";
            } else {
                html = `(${aTerm} + ${B})(${aTerm} - ${B})`;
                formula = "提示: (a + b)(a - b) = a² - b²";
            }

            document.getElementById('problem-text').innerHTML = html;
            document.getElementById('formula-text').textContent = formula;
        }

        function showHint() {
            document.getElementById('hint-panel').classList.remove('hidden');
            document.getElementById('hint-btn').classList.add('hidden');
        }

        function toggleSign(btnId) {
            const btn = document.getElementById(btnId);
            if (btn.disabled) return;

            const current = btn.dataset.sign;
            const next = current === '+' ? '-' : '+';
            
            btn.dataset.sign = next;
            btn.textContent = next;
            
            // Reset base classes
            btn.className = '';
            btn.classList.add(...BTN_BASE_CLASSES);

            // Apply color classes
            if (next === '-') {
                btn.classList.add(...BTN_MINUS_CLASSES);
            } else {
                btn.classList.add(...BTN_PLUS_CLASSES);
            }
        }

        function getSignedValue(signId, inputId) {
            const sign = document.getElementById(signId).dataset.sign === '-' ? -1 : 1;
            const valStr = document.getElementById(inputId).value;
            if (valStr === '') return null;
            return sign * parseInt(valStr);
        }

        function checkAnswer() {
            hideKeyboard();
            
            // Get inputs
            // For the first term (x^2), there is no sign button in front, assume positive
            const valAStr = document.getElementById('ans-a').value;
            const valA = valAStr === '' ? null : parseInt(valAStr);
            
            const valB = getSignedValue('sign-1', 'ans-b');
            const valC = getSignedValue('sign-2', 'ans-c');

            if (valA === null || valB === null || valC === null) {
                showFeedback('warning', 'Incomplete', '請填寫所有欄位。如果係數是 0，請填寫 0。');
                return;
            }

            // Calculate Correct Answer
            const { type, A, B } = currentProblem;
            let correctA, correctB, correctC;

            // Term x^2: (Ax)^2 = A^2 * x^2
            correctA = A * A;

            // Term Constant: B^2 or -B^2
            if (type === TYPE_DIFF_SQUARES) {
                correctC = -(B * B); // Difference of squares ends in -b^2
            } else {
                correctC = B * B; // Complete squares always end in +b^2
            }

            // Term x: 2AB or -2AB or 0
            if (type === TYPE_SQUARE_SUM) {
                correctB = 2 * A * B;
            } else if (type === TYPE_SQUARE_DIFF) {
                correctB = -(2 * A * B);
            } else {
                correctB = 0; // Middle term cancels out
            }

            // Validate
            if (valA === correctA && valB === correctB && valC === correctC) {
                handleCorrect();
            } else {
                handleIncorrect(correctA, correctB, correctC);
            }
        }

        function handleCorrect() {
            score += 10;
            document.getElementById('score-display').textContent = score;
            
            showFeedback('success', 'Correct!', '太棒了！答案完全正確。');
            
            // Lock inputs
            document.querySelectorAll('input, .sign-btn').forEach(el => el.disabled = true);
            document.getElementById('check-btn').classList.add('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
        }

        function handleIncorrect(cA, cB, cC) {
            let explanation = `正確答案應該是: ${cA}x² ${cB >= 0 ? '+' : ''}${cB}x ${cC >= 0 ? '+' : ''}${cC}`;
            
            // Specific hints based on error
            const { type } = currentProblem;
            if (type === TYPE_DIFF_SQUARES) {
                explanation += " (平方差公式中間項 x 的係數為 0，常數項為負)";
            } else if (type === TYPE_SQUARE_DIFF) {
                explanation += " (差的平方公式中間項應為負數)";
            }

            showFeedback('error', 'Incorrect', explanation);
        }

        function showFeedback(type, title, msg) {
            const area = document.getElementById('feedback-area');
            const iconDiv = document.getElementById('feedback-icon');
            const titleEl = document.getElementById('feedback-title');
            const detailEl = document.getElementById('feedback-detail');

            area.classList.remove('hidden', 'bg-green-50', 'border-green-500', 'bg-rose-50', 'border-rose-500', 'bg-amber-50', 'border-amber-500');
            iconDiv.innerHTML = '';
            iconDiv.className = 'p-2 rounded-full shrink-0'; // Reset

            if (type === 'success') {
                area.classList.add('bg-green-50', 'border-green-500', 'text-green-900');
                iconDiv.classList.add('bg-green-200', 'text-green-700');
                iconDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            } else if (type === 'error') {
                area.classList.add('bg-rose-50', 'border-rose-500', 'text-rose-900');
                iconDiv.classList.add('bg-rose-200', 'text-rose-700');
                iconDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
            } else {
                area.classList.add('bg-amber-50', 'border-amber-500', 'text-amber-900');
                iconDiv.classList.add('bg-amber-200', 'text-amber-700');
                iconDiv.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
            }

            titleEl.textContent = title;
            detailEl.textContent = msg;
        }
    </script>
</body>
</html>
